import streamlit as st
import requests
import json
import base64
import io
from PIL import Image
import random
import os
import torch
from transformers import AutoTokenizer, AutoModelForCausalLM, AutoProcessor
import time

# Configuration de la page
st.set_page_config(
    page_title="AgriLens AI - Gemma Local",
    page_icon="üåæ",
    layout="wide"
)

# Titre principal
st.title("üåæ AgriLens AI")
st.markdown("### Assistant IA pour l'Agriculture (Gemma Local)")

# Sidebar
st.sidebar.header("‚öôÔ∏è Configuration")

# Mode d'utilisation
mode = st.sidebar.selectbox(
    "Mode d'utilisation",
    ["üí¨ Mode Chat", "üì∑ Analyse d'Image", "üì§ Upload d'Image"]
)

# Token API (optionnel pour fallback)
api_token = st.sidebar.text_input(
    "üîë Token Hugging Face (fallback)",
    type="password",
    help="Pour utiliser l'API Hugging Face en fallback"
)

# S√©lection du mod√®le (seulement si token fourni)
if api_token and api_token.strip():
    model_options = {
        "microsoft/DialoGPT-small": "DialoGPT Small (API - Fallback)",
        "gpt2": "GPT-2 (API - Fallback)",
        "distilgpt2": "DistilGPT-2 (API - Fallback)"
    }
    
    selected_model = st.sidebar.selectbox(
        "ü§ñ Mod√®le API (fallback)",
        list(model_options.keys()),
        format_func=lambda x: model_options[x],
        index=0
    )
else:
    selected_model = "local"

# Chemin vers le mod√®le Gemma local
GEMMA_MODEL_PATH = r"D:\Dev\model_gemma"

# Variables globales pour le mod√®le
@st.cache_resource
def load_gemma_model():
    """Charge le mod√®le Gemma local"""
    try:
        st.info("üîÑ Chargement du mod√®le Gemma local...")
        
        # V√©rifier si le mod√®le existe
        if not os.path.exists(GEMMA_MODEL_PATH):
            st.error(f"‚ùå Mod√®le Gemma non trouv√© dans {GEMMA_MODEL_PATH}")
            return None, None
        
        # Charger le tokenizer
        tokenizer = AutoTokenizer.from_pretrained(GEMMA_MODEL_PATH)
        
        # Charger le mod√®le
        model = AutoModelForCausalLM.from_pretrained(
            GEMMA_MODEL_PATH,
            torch_dtype=torch.float16,
            device_map="auto" if torch.cuda.is_available() else None,
            trust_remote_code=True
        )
        
        st.success("‚úÖ Mod√®le Gemma charg√© avec succ√®s !")
        return model, tokenizer
        
    except Exception as e:
        st.error(f"‚ùå Erreur lors du chargement du mod√®le : {e}")
        return None, None

# Charger le mod√®le
gemma_model, gemma_tokenizer = load_gemma_model()

# Fonction pour appeler l'API avec gestion d'erreur am√©lior√©e
def call_api_safe(prompt, model_id, token=None):
    """Appelle l'API Hugging Face avec gestion d'erreur robuste"""
    if not token or not token.strip():
        return "‚ùå Token requis pour l'API Hugging Face"
    
    try:
        url = f"https://api-inference.huggingface.co/models/{model_id}"
        
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {token}"
        }
        
        payload = {
            "inputs": prompt,
            "parameters": {
                "max_new_tokens": 150,
                "temperature": 0.7,
                "do_sample": True,
                "return_full_text": False
            }
        }
        
        response = requests.post(url, headers=headers, json=payload, timeout=30)
        
        if response.status_code == 200:
            result = response.json()
            if isinstance(result, list) and len(result) > 0:
                return result[0].get("generated_text", str(result[0]))
            return str(result)
        elif response.status_code == 404:
            return f"‚ùå Mod√®le {model_id} non disponible via l'API gratuite."
        elif response.status_code == 503:
            return "üîÑ Le mod√®le est en cours de chargement. R√©essayez dans quelques secondes."
        elif response.status_code == 401:
            return "‚ùå Token invalide ou expir√©. V√©rifiez votre token Hugging Face."
        elif response.status_code == 429:
            return "‚è≥ Trop de requ√™tes. Attendez un moment."
        else:
            return f"‚ùå Erreur API ({response.status_code}): {response.text[:100]}"
            
    except requests.exceptions.Timeout:
        return "‚è∞ Timeout - Le serveur met trop de temps √† r√©pondre."
    except requests.exceptions.ConnectionError:
        return "üåê Erreur de connexion - V√©rifiez votre internet."
    except Exception as e:
        return f"‚ùå Erreur inattendue : {str(e)[:100]}"

# Fonction pour g√©n√©rer avec Gemma local
def generate_with_gemma(prompt, max_length=200):
    """G√©n√®re une r√©ponse avec le mod√®le Gemma local"""
    try:
        if gemma_model is None or gemma_tokenizer is None:
            return "‚ùå Mod√®le Gemma non disponible"
        
        # Pr√©parer le prompt pour Gemma
        if "agriculture" in prompt.lower() or "plante" in prompt.lower() or "culture" in prompt.lower():
            context = "Tu es un expert en agriculture. R√©ponds de mani√®re utile et pr√©cise."
        else:
            context = "Tu es un assistant IA utile et amical. R√©ponds de mani√®re naturelle et appropri√©e."
        full_prompt = f"{context}\n\nQuestion: {prompt}\n\nR√©ponse:"
        
        # Encoder le prompt avec limite optimis√©e
        inputs = gemma_tokenizer(
            full_prompt, 
            return_tensors="pt",
            padding=True,
            truncation=True,
            max_length=1024  # Limite optimis√©e pour le prompt
        )
        attention_mask = inputs["attention_mask"] if "attention_mask" in inputs else None

        # G√©n√©rer la r√©ponse avec param√®tres par d√©faut
        with torch.inference_mode():
            try:
                # Param√®tres par d√©faut Hugging Face
                outputs = gemma_model.generate(
                    inputs.input_ids,
                    attention_mask=attention_mask,
                    max_new_tokens=20,   # Valeur par d√©faut
                    temperature=0.7,     # Temp√©rature standard
                    do_sample=True,
                    pad_token_id=gemma_tokenizer.eos_token_id,
                    use_cache=False       # D√©sactiver le cache probl√©matique
                )
            except Exception as e:
                # Fallback simple sans cache
                outputs = gemma_model.generate(
                    inputs.input_ids,
                    attention_mask=attention_mask,
                    max_new_tokens=20,   # Fallback par d√©faut
                    pad_token_id=gemma_tokenizer.eos_token_id,
                    use_cache=False
                )
        
        # D√©coder la r√©ponse
        response = gemma_tokenizer.decode(outputs[0], skip_special_tokens=True)
        
        # Extraire seulement la partie g√©n√©r√©e
        if full_prompt in response:
            generated_part = response.split(full_prompt)[-1].strip()
        else:
            generated_part = response.strip()
        
        return generated_part if generated_part else "üåæ R√©ponse g√©n√©r√©e par Gemma local"
        
    except Exception as e:
        # Retourner l'erreur pour voir ce qui se passe
        return f"‚ùå Erreur Gemma : {str(e)[:100]}"

# Fonction de r√©ponse locale intelligente (fallback)
def generate_smart_response(prompt, conversation_history=None):
    """G√©n√®re une r√©ponse intelligente bas√©e sur le contexte (fallback)"""
    try:
        prompt_lower = prompt.lower().strip()
        
        # Salutations et pr√©sentations
        greetings = ["bonjour", "salut", "hello", "hi", "coucou", "hey"]
        if any(greeting in prompt_lower for greeting in greetings):
            responses = [
                "üåæ Bonjour ! Je suis votre assistant agricole. Je peux vous aider avec des conseils sur la culture, les maladies des plantes, l'am√©lioration du sol, et bien plus encore. Que souhaitez-vous savoir ?",
                "üå± Salut ! Je suis sp√©cialis√© en agriculture et jardinage. Posez-moi vos questions sur les cultures, les techniques, ou l'analyse d'images agricoles !",
                "üë®‚Äçüåæ Bonjour ! Votre expert agricole est l√† pour vous aider. Cultures, soins, maladies, sol... je peux tout vous expliquer !"
            ]
            return random.choice(responses)
        
        # Questions sur les capacit√©s
        if any(word in prompt_lower for word in ["peux-tu", "peux tu", "peut-il", "peut il", "capacit√©s", "faire quoi", "aider"]):
            return "üåæ **Mes capacit√©s** :\n\n‚Ä¢ **Conseils de culture** : tomates, l√©gumes, fruits\n‚Ä¢ **Diagnostic de maladies** : identification et traitements\n‚Ä¢ **Am√©lioration du sol** : types, engrais, techniques\n‚Ä¢ **Techniques d'arrosage** : optimisation et signes\n‚Ä¢ **Calendrier de plantation** : saisons et p√©riodes\n‚Ä¢ **Plantes compagnes** : associations b√©n√©fiques\n‚Ä¢ **Analyse d'images** : diagnostic visuel\n\nQue voulez-vous explorer ?"
        
        # Analyse d'images
        if "analyse d'image" in prompt_lower:
            # D√©tecter si c'est une laitue
            if "laitue" in prompt_lower or "salade" in prompt_lower:
                return """ü•¨ **Analyse de feuille de laitue attaqu√©e** :

**IDENTIFICATION** : Feuille de laitue avec signes d'attaque

**DIAGNOSTIC** : Probl√®mes courants sur laitue :
‚Ä¢ Limaces : trous irr√©guliers sur les feuilles
‚Ä¢ Pucerons : colonies sous les feuilles, d√©coloration
‚Ä¢ Altises : petits trous ronds caract√©ristiques
‚Ä¢ Chenilles : d√©g√¢ts sur les bords des feuilles
‚Ä¢ Mildiou : taches jaunes puis brunes

**RECOMMANDATIONS** :
‚Ä¢ Pi√®ges √† limaces (bi√®re, planches)
‚Ä¢ Savon noir contre pucerons
‚Ä¢ Bacillus thuringiensis contre chenilles
‚Ä¢ Rotation des cultures
‚Ä¢ Am√©lioration de la circulation d'air"""
            else:
                return """üîç **Analyse d'image agricole** :

**IDENTIFICATION** : Je peux identifier les types de plantes (riz, ma√Øs, bl√©, agrumes, tomates, laitue, etc.)

**DIAGNOSTIC** : Je d√©tecte les probl√®mes courants :
‚Ä¢ Maladies : taches, pourriture, jaunissement
‚Ä¢ Carences : d√©coloration, d√©formation
‚Ä¢ Ravageurs : trous, galeries, traces

**RECOMMANDATIONS** : Je propose des solutions :
‚Ä¢ Traitements naturels et chimiques
‚Ä¢ Am√©lioration des conditions
‚Ä¢ Pr√©vention des probl√®mes

D√©crivez-moi ce que vous voyez sur l'image pour un diagnostic pr√©cis !"""
        
        # Base de connaissances agricole √©tendue avec identification pr√©cise
        knowledge_base = {
            "riz": {
                "identification": "üåæ **Identification du riz** :\n- Plantes herbac√©es de 1-2m de haut\n- Feuilles longues et √©troites\n- Inflorescences en panicules\n- Grains group√©s en √©pillets\n- Culture en eau ou sec selon vari√©t√©",
                "maladies": "ü¶† **Maladies du riz** :\n- Pyriculariose : taches brunes en forme d'≈ìil\n- Helminthosporiose : taches ovales brunes\n- Pourriture des racines : jaunissement, fl√©trissement\n- Virus de la tungro : stries jaunes sur feuilles",
                "soins": "üíä **Traitements** :\n- Rotation des cultures\n- Vari√©t√©s r√©sistantes\n- Fongicides naturels (bicarbonate)\n- Drainage appropri√©"
            },
            "ma√Øs": {
                "identification": "üåΩ **Identification du ma√Øs** :\n- Plantes hautes (2-3m)\n- Tige robuste avec n≈ìuds\n- Feuilles larges et longues\n- Inflorescences m√¢les en panicule\n- √âpis femelles avec soies",
                "maladies": "ü¶† **Maladies du ma√Øs** :\n- Helminthosporiose : taches grises allong√©es\n- Rouille : pustules orange-brunes\n- Pourriture des tiges : tiges creuses\n- Virus de la mosa√Øque : stries jaunes"
            },
            "bl√©": {
                "identification": "üåæ **Identification du bl√©** :\n- Plantes de 0.6-1.5m\n- Tiges creuses (chaumes)\n- Feuilles √©troites et longues\n- √âpis compacts avec barbes\n- Grains nus",
                "maladies": "ü¶† **Maladies du bl√©** :\n- Rouille : pustules orange\n- Septoriose : taches brunes\n- O√Ødium : poudre blanche\n- Fusariose : √©pis d√©color√©s"
            },
            "sorgho": {
                "identification": "üåæ **Identification du sorgho** :\n- Plantes hautes (1-4m)\n- Tiges robustes\n- Feuilles larges avec nervure centrale\n- Inflorescences en panicules denses\n- Grains ronds ou ovales",
                "maladies": "ü¶† **Maladies du sorgho** :\n- Anthracnose : taches rouges\n- Mildiou : d√©coloration des feuilles\n- Charbon : masses noires sur grains"
            },
            "agrumes": {
                "identification": "üçä **Identification des agrumes** :\n- Feuilles ovales, brillantes\n- Nervures bien marqu√©es\n- Bordure lisse ou l√©g√®rement dent√©e\n- Odeur caract√©ristique au froissement",
                "maladies": "ü¶† **Maladies des agrumes** :\n- Cochenilles : taches blanches/cireuses\n- Mineuse : galeries dans les feuilles\n- Mal secco : taches brunes, feuilles qui tombent\n- Tristeza : jaunissement, d√©formation",
                "traitements": "üíä **Traitements** :\n- Huile de neem contre les insectes\n- Fongicides naturels (bicarbonate)\n- Taille des parties malades\n- Am√©lioration de la circulation d'air"
            },
            "laitue": {
                "identification": "ü•¨ **Identification de la laitue** :\n- Feuilles larges et tendres\n- Forme de rosette\n- Couleur verte claire √† fonc√©e\n- Texture lisse ou fris√©e selon vari√©t√©",
                "maladies": "ü¶† **Maladies de la laitue** :\n- Mildiou : taches jaunes puis brunes\n- Botrytis : pourriture grise\n- Scl√©rotinia : pourriture blanche\n- Virus de la mosa√Øque : d√©coloration",
                "ravageurs": "üêõ **Ravageurs courants** :\n- Limaces : trous irr√©guliers\n- Pucerons : colonies sous les feuilles\n- Altises : petits trous ronds\n- Chenilles : d√©g√¢ts sur les bords",
                "traitements": "üíä **Traitements** :\n- Pi√®ges √† limaces (bi√®re, planches)\n- Savon noir contre pucerons\n- Bacillus thuringiensis contre chenilles\n- Rotation des cultures"
            },
            "tomate": {
                "culture": "üå± **Culture des tomates** :\n1) Plantez en plein soleil (6-8h/jour)\n2) Espacez de 60-90cm entre les plants\n3) Arrosez r√©guli√®rement √† la base\n4) Tuteurez les plants pour √©viter la pourriture\n5) Fertilisez avec du compost ou engrais √©quilibr√©\n6) Pincez les gourmands pour favoriser la production",
                "maladies": "ü¶† **Maladies courantes** :\n- Mildiou : taches brunes sur feuilles\n- O√Ødium : poudre blanche\n- Pourriture apicale : carence en calcium\n**Solutions** : rotation des cultures, a√©ration, traitement pr√©ventif"
            },
            "maladie": {
                "identification": "üîç **Identification des maladies** :\n- Feuilles jaunes : carence ou exc√®s d'eau\n- Taches brunes : champignons\n- Poudre blanche : o√Ødium\n- Pourriture : bact√©ries ou champignons",
                "traitement": "üíä **Traitements naturels** :\n1) Retirez les parties malades\n2) Am√©liorez la circulation d'air\n3) Utilisez du bicarbonate de soude\n4) Pulv√©risez du lait dilu√©\n5) Plantez des plantes compagnes"
            },
            "sol": {
                "amelioration": "üåç **Am√©lioration du sol** :\n1) Ajoutez du compost (30% du volume)\n2) Utilisez du paillage (paille, feuilles)\n3) Plantez des engrais verts (tr√®fle, moutarde)\n4) √âvitez le compactage\n5) Testez le pH (6.0-7.0 id√©al)\n6) Ajoutez de la mati√®re organique",
                "types": "üèóÔ∏è **Types de sol** :\n- Argileux : retient l'eau, ajoutez du sable\n- Sableux : draine vite, ajoutez de l'argile\n- Limoneux : √©quilibr√©, id√©al\n- Calcaire : ajoutez de la tourbe"
            },
            "arrosage": {
                "techniques": "üíß **Techniques d'arrosage optimal** :\n1) T√¥t le matin (avant 10h)\n2) √Ä la base des plantes\n3) √âvitez de mouiller les feuilles\n4) Adaptez selon la m√©t√©o\n5) Utilisez du paillage\n6) Arrosez profond√©ment mais moins souvent",
                "signes": "üîç **Signes de d√©shydratation** :\n- Feuilles fl√©tries le soir\n- Sol sec sur 2-3cm\n- Croissance ralentie\n- Fruits fendill√©s"
            },
            "printemps": {
                "legumes": "üå∏ **L√©gumes de printemps** :\n1) Pois (f√©vrier-mars) - r√©sistant au froid\n2) √âpinards (mars) - pousse vite\n3) Radis (mars-avril) - 3-4 semaines\n4) Laitues (avril) - plusieurs vari√©t√©s\n5) Carottes (avril-mai) - sol meuble\n6) Oignons (mars-avril) - bulbes ou graines",
                "conseils": "üìÖ **Conseils de plantation** :\n- Attendez que le sol soit r√©chauff√©\n- Prot√©gez des gel√©es tardives\n- Semez en √©chelon pour √©taler les r√©coltes\n- Utilisez des tunnels ou cloches"
            },
            "engrais": {
                "naturels": "üåø **Engrais naturels** :\n1) Compost : √©quilibr√©, am√©liore le sol\n2) Fumier : riche en azote\n3) Cendres : potassium et calcium\n4) Algues : oligo-√©l√©ments\n5) Sang s√©ch√© : azote rapide\n6) Poudre d'os : phosphore",
                "utilisation": "‚öñÔ∏è **Utilisation** :\n- Compost : 5-10cm en surface\n- Fumier : 3-6 mois avant plantation\n- Cendres : 100g/m¬≤ maximum\n- Algues : en pulv√©risation foliaire"
            },
            "compagnonnage": {
                "plantes": "ü§ù **Plantes compagnes** :\n- Tomates + Basilic : repousse les insectes\n- Carottes + Oignons : se prot√®gent mutuellement\n- Pois + Ma√Øs : le ma√Øs sert de tuteur\n- Salades + Radis : optimise l'espace\n- Courges + Ma√Øs + Haricots : les 3 s≈ìurs",
                "benefices": "‚ú® **B√©n√©fices** :\n- Repousse les ravageurs\n- Am√©liore la pollinisation\n- Optimise l'espace\n- Am√©liore la fertilit√©\n- Prot√®ge du vent"
            }
        }
        
        # Chercher des mots-cl√©s dans la question
        for keyword, info in knowledge_base.items():
            if keyword in prompt_lower:
                if isinstance(info, dict):
                    # Retourner toutes les informations disponibles
                    response = f"üåæ **{keyword.title()}** :\n\n"
                    for topic, content in info.items():
                        response += f"**{topic.title()}** :\n{content}\n\n"
                    return response
                else:
                    return f"üåæ **{keyword.title()}** : {info}"
        
        # Questions sp√©cifiques
        if any(word in prompt_lower for word in ["comment", "comment faire", "technique"]):
            suggestions = [
                "üåæ **Techniques agricoles** : Je peux vous expliquer comment cultiver des tomates, am√©liorer votre sol, optimiser l'arrosage, ou utiliser des engrais naturels. Que voulez-vous apprendre ?",
                "üå± **Conseils pratiques** : Dites-moi quelle culture vous int√©resse (tomates, carottes, salades...) ou quel aspect (sol, arrosage, maladies) et je vous donnerai des conseils d√©taill√©s !"
            ]
            return random.choice(suggestions)
        
        elif any(word in prompt_lower for word in ["quand", "saison", "p√©riode", "calendrier"]):
            return "üìÖ **Calendrier de plantation** :\n\n**Printemps** : Pois, √©pinards, radis, laitues, carottes, oignons\n**√ât√©** : Tomates, courgettes, haricots, ma√Øs\n**Automne** : √âpinards, m√¢che, choux, poireaux\n**Hiver** : Planification, pr√©paration du sol\n\nQuelle saison vous int√©resse ?"
        
        elif any(word in prompt_lower for word in ["probl√®me", "erreur", "difficult√©", "maladie"]):
            return "üîç **Diagnostic de probl√®mes** :\n\nD√©crivez-moi les sympt√¥mes que vous observez :\n- Couleur des feuilles (jaunes, brunes, blanches)\n- Aspect des tiges ou fruits\n- Comportement de la plante\n- Conditions m√©t√©o r√©centes\n\nJe pourrai alors vous aider √† identifier le probl√®me !"
        
        elif any(word in prompt_lower for word in ["merci", "thanks", "thank you"]):
            responses = [
                "üåæ De rien ! N'h√©sitez pas si vous avez d'autres questions sur l'agriculture !",
                "üå± Avec plaisir ! Votre jardinier virtuel est l√† pour vous aider !",
                "üë®‚Äçüåæ Je vous en prie ! Bon jardinage et n'h√©sitez pas √† revenir !"
            ]
            return random.choice(responses)
        
        # R√©ponse g√©n√©rique intelligente
        else:
            suggestions = [
                "üåæ **Sujets que je peux aborder** :\n‚Ä¢ Culture de l√©gumes (tomates, carottes, salades...)\n‚Ä¢ Am√©lioration du sol et engrais\n‚Ä¢ Techniques d'arrosage\n‚Ä¢ Diagnostic de maladies\n‚Ä¢ Plantes compagnes\n‚Ä¢ Calendrier de plantation\n\nQue voulez-vous explorer ?",
                "üå± **Je peux vous aider avec** :\n‚Ä¢ Conseils de plantation et culture\n‚Ä¢ Identification de probl√®mes\n‚Ä¢ Techniques d'am√©lioration du sol\n‚Ä¢ Optimisation de l'arrosage\n‚Ä¢ Associations de plantes\n\nPosez-moi une question sp√©cifique !",
                "üë®‚Äçüåæ **Votre expert agricole peut vous conseiller sur** :\n‚Ä¢ Toutes les cultures de l√©gumes\n‚Ä¢ Soins et entretien des plantes\n‚Ä¢ Diagnostic et traitement des maladies\n‚Ä¢ Am√©lioration de la fertilit√© du sol\n‚Ä¢ Techniques de jardinage √©cologique\n\nQue souhaitez-vous savoir ?"
            ]
            return random.choice(suggestions)
        
    except Exception as e:
        return f"‚ùå Erreur : {e}"

# Fonction pour analyser une image
def analyze_image(image, prompt=""):
    """Analyse une image avec Gemma local"""
    try:
        width, height = image.size
        
        # Utiliser directement Gemma local
        if gemma_model is not None and gemma_tokenizer is not None:
            st.info("ü§ñ Analyse avec Gemma Local...")
            
            if prompt:
                full_prompt = f"Analyse cette image: {prompt}. Image {width}x{height}px. Identifie plante et probl√®mes. R√©ponse compl√®te et structur√©e."
            else:
                full_prompt = f"Analyse image agricole {width}x{height}px. Identifie plante et probl√®mes (maladies, ravageurs, carences). R√©ponse compl√®te."
            
            # Utiliser directement generate_with_gemma sans try/catch
            return generate_with_gemma(full_prompt)
        
        # Si pas de mod√®le Gemma, utiliser le fallback
        st.info("üåæ Analyse avec base de connaissances agricoles")
        
        if prompt:
            return generate_smart_response(f"analyse d'image: {prompt}")
        else:
            return generate_smart_response("analyse d'image agricole")
        
    except Exception as e:
        return f"‚ùå Erreur : {e}"

# Interface principale
if mode == "üí¨ Mode Chat":
    st.header("üí¨ Mode Chat")
    
    if gemma_model is not None:
        st.info("ü§ñ Chat avec Gemma Local !")
    else:
        st.info("üåæ Chat avec l'assistant agricole (fallback) !")
    
    # Afficher les informations du mod√®le
    st.sidebar.markdown("---")
    st.sidebar.markdown("### üìä Informations")
    if gemma_model is not None:
        st.sidebar.info(f"**Mode** : Gemma Local\n**Chemin** : {GEMMA_MODEL_PATH}\n**Statut** : ‚úÖ Charg√©")
    else:
        st.sidebar.info("**Mode** : Local Fallback\n**Base** : Connaissances agricoles\n**Statut** : ‚úÖ Disponible")
    
    # Historique des messages
    if "messages" not in st.session_state:
        st.session_state.messages = []
    
    # Afficher l'historique
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
    
    # Zone de saisie
    st.markdown("---")
    st.subheader("üí≠ Posez votre question")
    
    user_question = st.text_input(
        "Votre question sur l'agriculture :",
        placeholder="Ex: Comment cultiver des tomates ?",
        key="chat_input"
    )
    
    # Bouton pour envoyer
    if st.button("üöÄ Envoyer", type="primary"):
        if user_question.strip():
            # Ajouter le message utilisateur
            st.session_state.messages.append({"role": "user", "content": user_question})
            
            # G√©n√©rer la r√©ponse
            try:
                with st.spinner("üîÑ G√©n√©ration de la r√©ponse..."):
                    if gemma_model is not None:
                        # Utiliser Gemma local
                        response = generate_with_gemma(user_question)
                    else:
                        # Mode fallback local
                        response = generate_smart_response(user_question, st.session_state.messages)
                
                st.session_state.messages.append({"role": "assistant", "content": response})
                st.rerun()
                
            except Exception as e:
                error_msg = f"‚ùå Erreur : {e}"
                st.error(error_msg)
                st.session_state.messages.append({"role": "assistant", "content": error_msg})
                st.rerun()
        else:
            st.warning("‚ö†Ô∏è Veuillez saisir une question.")
    
    # Bouton pour effacer l'historique
    if st.button("üóëÔ∏è Effacer l'historique"):
        st.session_state.messages = []
        st.rerun()

elif mode == "üì∑ Analyse d'Image":
    st.header("üì∑ Analyse d'Image")
    st.info("üöÄ Analyse d'images agricoles avec Gemma Local !")
    
    # Afficher les informations du mod√®le
    st.sidebar.markdown("---")
    st.sidebar.markdown("### üìä Informations")
    if gemma_model is not None:
        st.sidebar.info(f"**Mode** : Gemma Local\n**Chemin** : {GEMMA_MODEL_PATH}\n**Statut** : ‚úÖ Charg√©")
    else:
        st.sidebar.info("**Mode** : Local Fallback\n**Base** : Connaissances agricoles\n**Statut** : ‚úÖ Disponible")
    
    # Onglets
    tab1, tab2, tab3 = st.tabs(["üì§ Upload", "üåê URL", "üì∏ Webcam"])
    
    with tab1:
        st.subheader("üì§ Upload d'Image")
        uploaded_file = st.file_uploader(
            "Choisissez une image...",
            type=['png', 'jpg', 'jpeg', 'gif', 'bmp']
        )
        
        if uploaded_file is not None:
            image = Image.open(uploaded_file)
            st.image(image, caption="Image upload√©e")
            
            # Prompt personnalis√©
            custom_prompt = st.text_area(
                "üí≠ Question sp√©cifique (optionnel)",
                placeholder="Ex: Identifie les maladies pr√©sentes sur ces feuilles"
            )
            
            if st.button("üîç Analyser", type="primary"):
                with st.spinner("üîÑ Analyse en cours..."):
                    result = analyze_image(image, custom_prompt)
                    st.markdown("### üìä R√©sultats de l'Analyse")
                    st.write(result)
    
    with tab2:
        st.subheader("üåê Image depuis URL")
        url = st.text_input(
            "Entrez l'URL de l'image",
            placeholder="https://example.com/image.jpg"
        )
        
        if url:
            if st.button("üì• T√©l√©charger et Analyser", type="primary"):
                try:
                    response = requests.get(url, timeout=10)
                    response.raise_for_status()
                    image = Image.open(io.BytesIO(response.content))
                    st.image(image, caption="Image t√©l√©charg√©e")
                    
                    with st.spinner("üîÑ Analyse en cours..."):
                        result = analyze_image(image, "")
                        st.markdown("### üìä R√©sultats de l'Analyse")
                        st.write(result)
                except Exception as e:
                    st.error(f"‚ùå Erreur : {e}")
    
    with tab3:
        st.subheader("üì∏ Capture Webcam")
        camera_input = st.camera_input("üì∏ Prenez une photo")
        
        if camera_input is not None:
            image = Image.open(camera_input)
            st.image(image, caption="Image captur√©e")
            
            custom_prompt = st.text_area(
                "üí≠ Question sp√©cifique (optionnel)",
                placeholder="Ex: Identifie les maladies pr√©sentes sur ces feuilles"
            )
            
            if st.button("üîç Analyser", type="primary"):
                with st.spinner("üîÑ Analyse en cours..."):
                    result = analyze_image(image, custom_prompt)
                    st.markdown("### üìä R√©sultats de l'Analyse")
                    st.write(result)

elif mode == "üì§ Upload d'Image":
    st.header("üì§ Upload d'Image Simple")
    st.info("üéØ Version simplifi√©e avec Gemma Local")
    
    uploaded_file = st.file_uploader(
        "Choisissez une image agricole...",
        type=['png', 'jpg', 'jpeg']
    )
    
    if uploaded_file is not None:
        image = Image.open(uploaded_file)
        st.image(image, caption="Image √† analyser")
        
        if st.button("üöÄ Analyser", type="primary"):
            with st.spinner("üîÑ Analyse en cours..."):
                result = analyze_image(image, "")
                st.markdown("### üìä Analyse")
                st.write(result)

# Informations
st.sidebar.markdown("---")
st.sidebar.markdown("### ‚ÑπÔ∏è √Ä propos")
st.sidebar.info(
    "**Gemma Local** :\n"
    "‚Ä¢ Mod√®le local puissant\n"
    "‚Ä¢ Pas de d√©pendance API\n"
    "‚Ä¢ R√©ponses intelligentes\n"
    "‚Ä¢ Analyse d'images\n\n"
    "**Fallback** :\n"
    "‚Ä¢ Base de connaissances\n"
    "‚Ä¢ Fonctionne sans mod√®le\n"
    "‚Ä¢ R√©ponses instantan√©es"
)

# Note sur le mod√®le
if gemma_model is not None:
    st.sidebar.success("‚úÖ Gemma Local activ√©")
else:
    st.sidebar.warning("‚ö†Ô∏è Gemma non disponible - Mode fallback")

# Footer
st.markdown("---")
st.markdown(
    """
    <div style='text-align: center; color: #666;'>
        üåæ AgriLens AI - Gemma Local<br>
        Mod√®le Local + Fallback Intelligent
    </div>
    """,
    unsafe_allow_html=True
) 